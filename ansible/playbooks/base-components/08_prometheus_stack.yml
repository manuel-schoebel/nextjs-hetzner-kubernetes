---
- name: Install kube-prometheus-stack
  hosts: server0
  become: yes
  vars_files:
    - ../../secrets_{{ env }}.yml
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  tasks:
    # - name: Uninstall
    #   shell: |
    #     helm uninstall kube-prometheus-stack -n monitoring
    #     kubectl delete namespace monitoring

    - name: Create monitoring namespace
      shell: |
        kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -

    - name: Copy prometheus stack values
      template:
        src: 08_prometheus_stack_values.yml.j2
        dest: /tmp/prometheus_stack_values.yml
        owner: root
        group: root
        mode: "0644"

    - name: Install kube-prometheus-stack
      shell: |
        helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
        helm repo update
        helm upgrade --install kube-prometheus-stack prometheus-community/kube-prometheus-stack \
          --namespace monitoring \
          --version 66.3.1 \
          -f /tmp/prometheus_stack_values.yml \
          --timeout 10m \
          --wait

    - name: Wait for Prometheus to be ready
      shell: |
        kubectl wait --for=condition=available deployment/kube-prometheus-stack-operator -n monitoring --timeout=300s

    - name: Display access information
      debug:
        msg: |
          Prometheus stack installed successfully!

          Access Grafana:
            kubectl port-forward svc/kube-prometheus-stack-grafana -n monitoring 3000:80
            URL: http://localhost:3000
            User: admin
            Password: Run 'kubectl get secret kube-prometheus-stack-grafana -n monitoring -o jsonpath="{.data.admin-password}" | base64 -d'

          Access Prometheus:
            kubectl port-forward svc/kube-prometheus-stack-prometheus -n monitoring 9090:9090
            URL: http://localhost:9090
